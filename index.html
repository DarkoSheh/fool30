<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–ú–æ—è –ò–≥—Ä–∞ (Brython) ‚Äî –ù–µ—Å–∫–æ–ª—å–∫–æ –ò–ò (3‚Äì4 –∏–≥—Ä–æ–∫–æ–≤), –∑–µ–ª—ë–Ω–æ–µ –ø–æ–ª–µ + –∫–æ–∑—ã—Ä—å</title>

  <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Brython -->
  <script src="https://cdn.jsdelivr.net/npm/brython@3/brython.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/brython@3/brython_stdlib.js"></script>

  <!-- CSS —Å—Ç–∏–ª–∏ -->
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    body {
      margin: 0; 
      padding: 0;
      font-family: Arial, sans-serif;
      background: #eee; 
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background: #3f51b5;
      color: white;
      width: 100%;
      padding: 1rem;
      text-align: center;
      margin-bottom: 1rem;
    }
    /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Ç–µ–ø–µ—Ä—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    #menu-screen {
      background: white;
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }
    .container {
      background: white; 
      margin: 1rem;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    button {
      background: #3f51b5;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 0.5rem 1rem;
      margin: 0.5rem 0;
      cursor: pointer;
    }
    button:hover {
      background: #32408f;
    }

    /* –≠–∫—Ä–∞–Ω—ã (—Å–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ, –∫—Ä–æ–º–µ menu) */
    #newgame-screen, #achievements-screen, #rules-screen,
    #settings-screen, #game-screen, #aifull-screen, #aifull-multi-screen,
    #profile-screen {
      display: none;
    }

    #newgame-screen {
    width: 400px;       /* –∏–ª–∏ 500px, –∫–∞–∫ –≤–∞–º —É–¥–æ–±–Ω–µ–µ */
    min-height: 500px;  /* –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –∑–∞–¥–∞—Ç—å –≤—ã—Å–æ—Ç—É */
    margin: 2rem auto;  /* —á—Ç–æ–±—ã —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å */
    box-sizing: border-box; /* –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π */
    }
    
    /* –ó–µ–ª–µ–Ω–æ–µ –∏–≥—Ä–æ–≤–æ–µ –ø–æ–ª–µ –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω */
    .game-field {
      background: #2e7d32;
      color: #fff;
      position: relative;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      padding: 1rem;
      box-sizing: border-box;
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–∑—ã—Ä—è –∏ —Å—Ç–æ–ø–∫–∏ "–±–∏—Ç–æ" ‚Äì –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É (—Ç–æ–ª—å–∫–æ –≤ –∏–≥—Ä–æ–≤—ã—Ö —ç–∫—Ä–∞–Ω–∞—Ö) */
    #aifull-screen .trump-discard-container,
    #aifull-multi-screen .trump-discard-container {
      display: flex;
      gap: 1rem;
      position: absolute;
      top: 20px;
      right: 20px;
      left: auto;
      z-index: 100;
    }
    /* –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞–µ–≤ */
    .trump-discard-container {
      display: flex;
      gap: 1rem;
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 100;
    }
    /* –ö–æ–∑—ã—Ä–Ω–∞—è –∫–∞—Ä—Ç–∞ */
    #trump-card, #trump-card-multi {
      width: 60px;
      height: 90px;
      background: #fff;
      color: #333;
      border: 2px solid #333;
      border-radius: 10px;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 1.2rem;
    }
    /* –°—Ç–æ–ø–∫–∞ "–±–∏—Ç–æ" ‚Äì —Ä–∞–∑–º–µ—Ä—ã —Å–æ–≤–ø–∞–¥–∞—é—Ç —Å –∫–æ–∑—ã—Ä–Ω–æ–π –∫–∞—Ä—Ç–æ–π */
    #discard-pile, #discard-pile-multi {
      width: 60px;
      height: 90px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .card-back {
      background: #333;
      border: 2px solid #666;
      border-radius: 10px;
      width: 60px;
      height: 90px;
    }

    /* –ó–µ–ª–µ–Ω—ã–π –ª–æ–≥ */
    .green-log {
      background: #2e7d32;
      color: #fff;
      border: 1px solid #4caf50;
      padding: 1rem;
      min-height: 150px;
      overflow-y: auto;
      margin-bottom: 1rem;
      border-radius: 5px;
    }

    /* –ö–∞—Ä—Ç–æ—á–Ω—ã–π –¥–∏–∑–∞–π–Ω */
    .card-list {
      margin: 0.5rem 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .card-item {
      background: #fff;
      color: #333;
      border: 2px solid #ccc;
      border-radius: 10px;
      width: 60px;
      height: 90px;
      margin: 0.3rem;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .card-item:hover {
      background: #f8f8f8;
    }

    .rules-block h3 {
      margin-top: 0.5rem;
      margin-bottom: 0.3rem;
    }
    .rules-block p {
      margin-top: 0.2rem;
      margin-bottom: 0.8rem;
      line-height: 1.4;
    }

    /* –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û: –æ–±—â–∏–π —Å—Ç–∏–ª—å action-message */
    .action-message {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: yellow;
    }
  </style>
</head>

<body onload="brython()">
<header>
  <h1>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –º–æ–µ–π –∏–≥—Ä—ã</h1>
</header>

<!-- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é (–Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω) -->
<div class="container" id="menu-screen">
  <h2>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</h2>
  <button onclick="open_screen('newgame')">–ù–æ–≤–∞—è –∏–≥—Ä–∞</button><br>
  <button onclick="open_screen('achievements')">–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button><br>
  <button onclick="open_screen('rules')">–ü—Ä–∞–≤–∏–ª–∞</button><br>
  <button onclick="open_screen('settings')">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button><br>
  <!-- –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞: –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç -->
  <button onclick="open_screen('profile')">–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç" (profile) -->
<div class="container" id="profile-screen">
  <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
  <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è:</p>
  <input type="text" id="player_name_input" value="–ò–≥—Ä–æ–∫" style="width:200px;" />
  <br><br>
  <button onclick="save_player_name()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ù–æ–≤–∞—è –∏–≥—Ä–∞" -->
<div class="container" id="newgame-screen">
  <h2>–ù–æ–≤–∞—è –∏–≥—Ä–∞</h2>
  <label>–†–µ–∂–∏–º –∏–≥—Ä—ã:</label><br>
  <select id="select_mode">
    <option value="classic">–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π</option>
    <option value="podkidnoi">–ü–æ–¥–∫–∏–¥–Ω–æ–π</option>
    <option value="perevodnoi">–ü–µ—Ä–µ–≤–æ–¥–Ω–æ–π</option>
    <option value="jokers">–° –¥–∂–æ–∫–µ—Ä–∞–º–∏</option>
    <option value="all">–í—Å–µ —Å—Ä–∞–∑—É</option>
  </select>
  <br><br>

  <label>
    <input type="checkbox" id="cb_jokers">
    –ò–≥—Ä–∞ —Å –¥–∂–æ–∫–µ—Ä–∞–º–∏
  </label>
  <br><br>

  <label>
    <input type="checkbox" id="cb_6plus">
    –ö–∞—Ä—Ç—ã —Ç–æ–ª—å–∫–æ 6..A
  </label>
  <br><br>

  <!-- AI –≤—ã–±–æ—Ä (2..4) -->
  <div id="ai-count-block" style="display:none; margin-bottom:1rem;">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (1 —Ä–µ–∞–ª—å–Ω—ã–π + (N-1) –ò–ò), –æ—Ç 2 –¥–æ 4:</label><br>
    <input type="number" id="ai_players_count" value="2" min="2" max="4" />
  </div>

  <!-- –º—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä (2..10) -->
  <div id="multi-count-block" style="display:none; margin-bottom:1rem;">
    <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤ (2..10):</label><br>
    <input type="number" id="multi_players_count" value="4" min="2" max="10" />
    <br><br>
    <p>–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä: –≤—ã–±—Ä–∞—Ç—å —Ç–∏–ø –∫–æ–º–Ω–∞—Ç—ã:</p>
    <label>
      <input type="radio" name="room_type" value="link" checked>
      –ü–æ —Å—Å—ã–ª–∫–µ
    </label><br>
    <label>
      <input type="radio" name="room_type" value="open">
      –û—Ç–∫—Ä—ã—Ç–∞—è
    </label>
  </div>

  <label>–¢–∏–ø –∏–≥—Ä—ã:</label><br>
  <label>
    <input type="radio" name="game_type" value="ai" checked>
    –ò–≥—Ä–∞ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é
  </label><br>
  <label>
    <input type="radio" name="game_type" value="multi">
    –ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä
  </label>
  <br><br>

  <button onclick="start_new_game()">–ù–∞—á–∞—Ç—å</button>
  <button onclick="back_to_menu()">–û—Ç–º–µ–Ω–∞</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è" -->
<div class="container" id="achievements-screen">
  <h2>–î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</h2>
  <p>–°–ø–∏—Å–æ–∫ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–π –ø–æ–∫–∞ –ø—É—Å—Ç.</p>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ü—Ä–∞–≤–∏–ª–∞" -->
<div class="container" id="rules-screen">
  <h2>–ü—Ä–∞–≤–∏–ª–∞</h2>
  <div class="rules-block">
    <p>–í –∏–≥—Ä–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ–ª–æ–¥–∞ –∏–∑ 7 –º–∞—Å—Ç–µ–π (‚ô†, ‚ô•, ‚ô¶, ‚ô£, ‚≠ê, üåô, ‚öú)
    –∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ 2 –æ—Å–æ–±—ã—Ö –¥–∂–æ–∫–µ—Ä–∞.
    –ú–æ–∂–Ω–æ –∏–≥—Ä–∞—Ç—å –∫–∞—Ä—Ç–∞–º–∏ –æ—Ç 2 –¥–æ A, –∏–ª–∏ —Ç–æ–ª—å–∫–æ —Å 6..A, –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫.</p>

    <h3>–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –¥—É—Ä–∞–∫:</h3>
    <p>–û–±—ã—á–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞: –∏–≥—Ä–æ–∫–∏ –∑–∞—â–∏—â–∞—é—Ç—Å—è –∏ –ø–æ–¥–∫–∏–¥—ã–≤–∞—é—Ç, –±–µ–∑ –ø–µ—Ä–µ–≤–æ–¥–æ–≤.
    –ö–æ–∑—ã—Ä–Ω–∞—è –º–∞—Å—Ç—å –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ. –î–∂–æ–∫–µ—Ä—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è,
    –µ—Å–ª–∏ –Ω–µ –æ—Ç–º–µ—á–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö.</p>

    <h3>–ü–æ–¥–∫–∏–¥–Ω–æ–π –¥—É—Ä–∞–∫:</h3>
    <p>–†–∞–∑—Ä–µ—à–∞–µ—Ç—Å—è –ø–æ–¥–∫–∏–¥—ã–≤–∞—Ç—å –∫–∞—Ä—Ç—ã —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞, —á—Ç–æ —É–∂–µ –Ω–∞ —Å—Ç–æ–ª–µ.
    –î–∂–æ–∫–µ—Ä—ã (–µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω—ã) –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç—ã.</p>

    <h3>–ü–µ—Ä–µ–≤–æ–¥–Ω–æ–π –¥—É—Ä–∞–∫:</h3>
    <p>–ï—Å–ª–∏ –æ—Ç–±–∏–≤–∞—é—â–∏–π—Å—è –º–æ–∂–µ—Ç –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ö–æ–¥ (–µ—Å—Ç—å –∫–∞—Ä—Ç–∞ —Ç–æ–≥–æ –∂–µ –¥–æ—Å—Ç–æ–∏–Ω—Å—Ç–≤–∞),
    –æ–Ω –ø–µ—Ä–µ–≤–æ–¥–∏—Ç –∞—Ç–∞–∫—É –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–≥—Ä–æ–∫–∞. –ù–∞–ª–∏—á–∏–µ 7 –º–∞—Å—Ç–µ–π –∏ 2 –¥–∂–æ–∫–µ—Ä–æ–≤
    –¥–æ–±–∞–≤–ª—è–µ—Ç –≤–∞—Ä–∏–∞—Ç–∏–≤–Ω–æ—Å—Ç–∏.</p>

    <h3>–° –¥–∂–æ–∫–µ—Ä–∞–º–∏ (–æ—Ç–¥–µ–ª—å–Ω—ã–π —Ä–µ–∂–∏–º):</h3>
    <p>–í—Å–µ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞, –Ω–æ –¥–∂–æ–∫–µ—Ä—ã –∏–≥—Ä–∞—é—Ç –æ—Å–æ–±—É—é —Ä–æ–ª—å,
    –º–æ–≥—É—Ç –±–∏—Ç—å –ª—é–±—ã–µ –∫–∞—Ä—Ç—ã, –∏–ª–∏ –¥–∞–∂–µ —Å—á–∏—Ç–∞—Ç—å—Å—è –∫–æ–∑—ã—Ä—è–º–∏ (–≤ —É–ø—Ä–æ—â—ë–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏).
    –ö–æ–ª–æ–¥–∞ —Å–Ω–æ–≤–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å 2..A –∏–ª–∏ 6..A –ø–ª—é—Å 2 –¥–∂–æ–∫–µ—Ä–∞.</p>

    <h3>–í—Å–µ —Å—Ä–∞–∑—É:</h3>
    <p>–û–±—ä–µ–¥–∏–Ω—è–µ—Ç –º–µ—Ö–∞–Ω–∏–∫–∏ –ø–æ–¥–∫–∏–¥–Ω–æ–≥–æ, –ø–µ—Ä–µ–≤–æ–¥–Ω–æ–≥–æ –∏ —Å –¥–∂–æ–∫–µ—Ä–∞–º–∏.
    –≠—Ç–æ —Å–∞–º—ã–π —Å–ª–æ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –º–Ω–æ–≥–æ –∫–∞—Ä—Ç (7 –º–∞—Å—Ç–µ–π, 2 –¥–∂–æ–∫–µ—Ä–∞),
    –º–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –∏ –ø–æ–¥–∫–∏–¥—ã–≤–∞—Ç—å. –û—á–µ–Ω—å —Ö–∞–æ—Ç–∏—á–Ω–æ –∏ –≤–µ—Å–µ–ª–æ!</p>
  </div>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" -->
<div class="container" id="settings-screen">
  <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
  <p>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±—É–¥—É—Ç —Ç—É—Ç...</p>
  <button onclick="back_to_menu()">–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "–ò–≥—Ä–∞" (–¥–ª—è MULTI –∏–ª–∏ AI>2) -->
<div class="container" id="game-screen">
  <h2>–ò–≥—Ä–∞ –Ω–∞—á–∞–ª–∞—Å—å!</h2>
  <p>–ü–æ–∫–∞ —Ç—É—Ç –Ω–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏ –∏–≥—Ä—ã. –í—ã –≤—ã–±—Ä–∞–ª–∏:</p>
  <p><strong>–†–µ–∂–∏–º:</strong> <span id="chosen_mode"></span></p>
  <p><strong>–î–∂–æ–∫–µ—Ä—ã:</strong> <span id="chosen_jokers"></span></p>
  <p><strong>–¢–æ–ª—å–∫–æ 6..A:</strong> <span id="chosen_6plus"></span></p>
  <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏–≥—Ä–æ–∫–æ–≤:</strong> <span id="chosen_players"></span></p>
  <p><strong>–¢–∏–ø –∏–≥—Ä—ã:</strong> <span id="chosen_type"></span> 
    ( <span id="chosen_room"></span> )
  </p>
  <button onclick="back_to_menu()">–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "aifull-screen" (2 –∏–≥—Ä–æ–∫–∞) -->
<div class="container game-field" id="aifull-screen">
  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–∑—ã—Ä—è –∏ —Å—Ç–æ–ø–∫–∏ "–±–∏—Ç–æ" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
  <div class="trump-discard-container">
    <div id="trump-card">?</div>
    <div id="discard-pile" style="display:none;"></div>
  </div>
  <h2>–ü–æ–ª–Ω–∞—è –ø–∞—Ä—Ç–∏—è —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é (2 –∏–≥—Ä–æ–∫–∞)</h2>
  <p>–ö—Ç–æ –ø–µ—Ä–≤—ã–π —Å–±—Ä–æ—Å–∏—Ç –∫–∞—Ä—Ç—ã ‚Äî —Ç–æ—Ç –≤—ã–∏–≥—Ä–∞–ª!</p>
  <p>–¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="current-turn"></span></p>

  <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: –∫—Ç–æ –∞—Ç–∞–∫—É–µ—Ç/–æ—Ç–±–∏–≤–∞–µ—Ç—Å—è -->
  <div id="aifull-action" class="action-message"></div>

  <div id="aifull-log" class="green-log"></div>
  <div id="aifull-visual-cards" style="margin-bottom:1rem; display:flex; gap:1rem; flex-wrap:wrap;"></div>
  
  <hr>
  <p><strong>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</strong></p>
  <ul class="card-list" id="user-cards-list"></ul>
  <button onclick="restart_aifull()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="back_to_menu()">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<!-- –≠–∫—Ä–∞–Ω "aifull-multi-screen" (3..4 –∏–≥—Ä–æ–∫–æ–≤) -->
<div class="container game-field" id="aifull-multi-screen">
  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–æ–∑—ã—Ä—è –∏ —Å—Ç–æ–ø–∫–∏ "–±–∏—Ç–æ" –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É -->
  <div class="trump-discard-container">
    <div id="trump-card-multi">?</div>
    <div id="discard-pile-multi" style="display:none;"></div>
  </div>
  <h2>–ü–æ–ª–Ω–∞—è –ø–∞—Ä—Ç–∏—è —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ò–ò (3‚Äì4 –∏–≥—Ä–æ–∫–æ–≤)</h2>
  <p>–ö—Ç–æ –ø–µ—Ä–≤—ã–π —Å–±—Ä–æ—Å–∏—Ç –∫–∞—Ä—Ç—ã ‚Äî —Ç–æ—Ç –≤—ã–∏–≥—Ä–∞–ª!<br>
     –¢–µ–∫—É—â–∏–π —Ö–æ–¥: <span id="multi-turn"></span></p>

  <!-- –ù–æ–≤—ã–π –±–ª–æ–∫ –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è: –∫—Ç–æ –∞—Ç–∞–∫—É–µ—Ç/–æ—Ç–±–∏–≤–∞–µ—Ç—Å—è -->
  <div id="aifull-multi-action" class="action-message"></div>

  <div id="aifull-multi-log" class="green-log"></div>
  <div id="aifull-multi-visual-cards" style="margin-bottom:1rem; display:flex; gap:1rem; flex-wrap:wrap;"></div>
  
  <hr>
  <p><strong>–í–∞—à–∏ –∫–∞—Ä—Ç—ã:</strong></p>
  <ul class="card-list" id="user-multi-cards"></ul>
  <button onclick="restart_aifull_multi()">–°—ã–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
  <button onclick="back_to_menu()">–í—ã–π—Ç–∏ –≤ –º–µ–Ω—é</button>
</div>

<script type="text/python">
########################################################
#          –ù–µ–∏–∑–º–µ–Ω—ë–Ω–Ω—ã–π/–∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ + –ø–∞—Ç—á–∏
########################################################
from browser import document, window
import random
from browser import timer

def switch_view(show_id):
    screens = [
        "menu-screen","newgame-screen","achievements-screen","rules-screen",
        "settings-screen","game-screen","aifull-screen","aifull-multi-screen",
        "profile-screen"  # –¥–æ–±–∞–≤–∏–ª–∏ —ç–∫—Ä–∞–Ω –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
    ]
    for s in screens:
        document[s].style.display = "none"
    document[show_id].style.display = "block"

def back_to_menu():
    if "trump-card" in document:
        document["trump-card"].style.display = "none"
    if "trump-card-multi" in document:
        document["trump-card-multi"].style.display = "none"
    if "discard-pile" in document:
        document["discard-pile"].style.display = "none"
        document["discard-pile"].clear()
    if "discard-pile-multi" in document:
        document["discard-pile-multi"].style.display = "none"
        document["discard-pile-multi"].clear()
    switch_view("menu-screen")

def open_screen(name):
    switch_view(name+"-screen")

def on_game_type_change(ev):
    check_game_type()

def check_game_type():
    radio_list = document.select("[name='game_type']")
    chosen = "ai"
    for r in radio_list:
        if r.checked:
            chosen = r.value
            break
    ai_block = document["ai-count-block"]
    multi_block = document["multi-count-block"]
    if chosen=="ai":
        ai_block.style.display = "block"
        multi_block.style.display = "none"
    else:
        ai_block.style.display = "none"
        multi_block.style.display = "block"

def init():
    for r in document.select("[name='game_type']"):
        r.bind("change", on_game_type_change)
    check_game_type()

init()

def rank_index(rank):
    order = ["2","3","4","5","6","7","8","9","10","J","Q","K","A"]
    return order.index(rank) if rank in order else -1

def can_defend(card_def, card_atk, trump_suit):
    rd, sd, jd = card_def
    ra, sa, ja = card_atk
    if jd:
        if ja:
            return False
        return True
    if ja:
        return False

    is_trump_def = (sd == trump_suit)
    is_trump_atk = (sa == trump_suit)

    if is_trump_def and not is_trump_atk:
        return True
    if not is_trump_def and is_trump_atk:
        return False

    if sd == sa:
        return rank_index(rd)>rank_index(ra)
    return False

def draw_until_6(hand, deck):
    while len(hand)<6 and len(deck)>0:
        hand.append(deck.pop(0))
    return hand

def create_deck(only_6plus, with_jokers):
    suits=["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    ranks_all=[str(n) for n in range(2,11)] + ["J","Q","K","A"]
    if only_6plus:
        ranks_all=[r for r in ranks_all if r not in ["2","3","4","5"]]
    d=[]
    for s in suits:
        for r in ranks_all:
            d.append((r,s,False))
    if with_jokers:
        d.append(("Joker-3","JokerSuit",True))
        d.append(("Joker-4","JokerSuit",True))
    return d

########################################################
#  ***** –û—á–µ—Ä–µ–¥—å –ø–æ–∫–∞–∑–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –∏ –∫–∞—Ä—Ç
########################################################
def display_card_visual(card, parent_id, label=""):
    global _card_queue, _busy
    _card_queue.append(('card', card, parent_id))
    if not _busy:
        _busy = True
        timer.set_timeout(delayed_show_next, 2000)

def clear_visual_cards(parent_id):
    container = document[parent_id]
    container.clear()

def set_action_message(screen_id, txt):
    pass

def clear_action_message(screen_id):
    document[screen_id+"-action"].innerHTML = ""

player_name = "–ò–≥—Ä–æ–∫"
def save_player_name():
    global player_name
    inp = document["player_name_input"].value
    if inp.strip():
        player_name = inp.strip()
    back_to_menu()

deck = []
AI_cards = []
user_cards = []
trump_suit = ""
current_attacker = "AI"
log_lines = []
allow_user_click = False

eliminated = []
ranks_done = 0
total_players_count = 0

def determine_first_attacker_2p():
    player_trumps = [card for card in user_cards if card[1] == trump_suit]
    ai_trumps = [card for card in AI_cards if card[1] == trump_suit]
    if player_trumps or ai_trumps:
        player_min = min([rank_index(card[0]) for card in player_trumps]) if player_trumps else None
        ai_min = min([rank_index(card[0]) for card in ai_trumps]) if ai_trumps else None
        if player_min is not None and ai_min is not None:
            if player_min < ai_min:
                return "player"
            else:
                return "AI"
        elif player_min is not None:
            return "player"
        elif ai_min is not None:
            return "AI"
    return "player"

def game_over_2p(winner):
    global user_cards, AI_cards, allow_user_click
    if winner=="player":
       patched_set_action_message("aifull", f"–ü–û–ë–ï–î–ò–¢–ï–õ–¨: {player_name.upper()}!")
    else:
       patched_set_action_message("aifull", "–ü–û–ë–ï–î–ò–¢–ï–õ–¨: –°–ï–õ–ï–°–¢–ò–Ø!")
    user_cards = []
    AI_cards = []
    document["aifull-visual-cards"].clear()
    allow_user_click = False

def check_win_conditions_2p():
    if len(user_cards) == 0:
         game_over_2p("player")
    elif len(AI_cards) == 0:
         game_over_2p("AI")

def start_aifull_game(only_6plus, with_jokers):
    global deck, AI_cards, user_cards, trump_suit, current_attacker, log_lines, allow_user_click
    deck = create_deck(only_6plus, with_jokers)
    random.shuffle(deck)
    AI_cards = deck[:6]
    user_cards = deck[6:12]
    del deck[:12]
    suits = ["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    trump_suit = random.choice(suits)
    current_attacker = determine_first_attacker_2p()
    log_lines = [f"–ù–∞—á–∏–Ω–∞–µ–º –ø–∞—Ä—Ç–∏—é (2 –∏–≥—Ä–æ–∫–∞)."]
    allow_user_click = False
    document["trump-card"].innerHTML = f"<div style='font-size:1.5rem;'>{trump_suit}</div>"
    document["trump-card"].style.display = "flex"
    clear_visual_cards("aifull-visual-cards")
    document["discard-pile"].clear()
    document["discard-pile"].style.display = "none"

    # (1) "X —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º!"
    if current_attacker == "player":
        patched_set_action_message("aifull", f"{player_name} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º!")
        allow_user_click = True
    else:
        patched_set_action_message("aifull", "–°–µ–ª–µ—Å—Ç–∏—è —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º!")
        timer.set_timeout(ai_attack, 2000)

    switch_view("aifull-screen")
    update_aifull_ui()

def ai_attack():
    global AI_cards, allow_user_click
    if len(AI_cards)==0:
        return
    # (2) "–°–µ–ª–µ—Å—Ç–∏—è –∞—Ç–∞–∫—É–µ—Ç –ò–≥—Ä–æ–∫" + –≤—ã–∫–ª–∞–¥–∫–∞ –∫–∞—Ä—Ç—ã => —Å–æ–æ–±—â. –∏ –∫–∞—Ä—Ç–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
    patched_set_action_message("aifull", "–°–µ–ª–µ—Å—Ç–∏—è –∞—Ç–∞–∫—É–µ—Ç –ò–≥—Ä–æ–∫–∞!")
    atk_card = AI_cards[0]
    display_card_visual(atk_card, "aifull-visual-cards", "")
    allow_user_click = True

def update_aifull_ui():
    document["aifull-log"].innerHTML = "<pre>" + "\n".join(log_lines) + "</pre>"
    turn_text = "–°–µ–ª–µ—Å—Ç–∏—è" if current_attacker=="AI" else player_name
    document["current-turn"].textContent = turn_text
    ul = document["user-cards-list"]
    ul.clear()
    for i, c in enumerate(user_cards):
        li = document.createElement("li")
        li.classList.add("card-item")
        li.innerHTML = str(c)
        def on_click(ev, idx=i):
            handle_card_click(idx)
        li.bind("click", on_click)
        ul.appendChild(li)
    check_win_conditions_2p()

def handle_card_click(idx):
    global deck, AI_cards, user_cards, trump_suit, current_attacker, allow_user_click
    if not allow_user_click:
        return
    if idx<0 or idx>=len(user_cards):
        return
    c = user_cards[idx]
    if current_attacker=="AI":
        # (3) "–ò–≥—Ä–æ–∫ –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è..."
        patched_clear_action("aifull")
        patched_set_action_message("aifull", f"{player_name} –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è...")
        atk_card = AI_cards[0]
        display_card_visual(c, "aifull-visual-cards", "")
        # –ø—Ä–æ–≤–µ—Ä—è–µ–º –∑–∞—â–∏—Ç—É
        if can_defend(c, atk_card, trump_suit):
            # (4) "–ò–≥—Ä–æ–∫ –æ—Ç–±–∏–ª—Å—è!", —É–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç—ã
            patched_set_action_message("aifull", f"{player_name} –æ—Ç–±–∏–ª—Å—è!")
            discard_cards_bito("aifull",[c,atk_card])
            AI_cards.pop(0)
            user_cards.pop(idx)
            current_attacker="player"
            # —Å–ª–µ–¥. –∞—Ç–∞–∫–∞ "–ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç –°–µ–ª–µ—Å—Ç–∏—é"
            patched_set_action_message("aifull", f"{player_name} –∞—Ç–∞–∫—É–µ—Ç –°–µ–ª–µ—Å—Ç–∏—é!")
        else:
            # (5) "–ò–≥—Ä–æ–∫ –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë–º –∫–∞—Ä—Ç—ã"
            patched_set_action_message("aifull", f"{player_name} –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë–º –∫–∞—Ä—Ç—ã")
            document["aifull-visual-cards"].clear()
            user_cards.append(atk_card)
            AI_cards.pop(0)
            # –¥–∞–ª–µ–µ "—Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫..."
            patched_set_action_message("aifull", f"–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –°–µ–ª–µ—Å—Ç–∏–∏. –°–µ–ª–µ—Å—Ç–∏—è –∞—Ç–∞–∫—É–µ—Ç –ò–≥—Ä–æ–∫–∞!")
        allow_user_click=False
        # –¥–æ–±–∏—Ä–∞–µ–º
        AI_cards=draw_until_6(AI_cards,deck)
        user_cards=draw_until_6(user_cards,deck)
        if current_attacker=="AI":
            timer.set_timeout(ai_attack,2000)
        else:
            allow_user_click=True
        update_aifull_ui()
    else:
        # (2) "–ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç –°–µ–ª–µ—Å—Ç–∏—é!"
        patched_clear_action("aifull")
        patched_set_action_message("aifull", f"{player_name} –∞—Ç–∞–∫—É–µ—Ç –°–µ–ª–µ—Å—Ç–∏—é!")
        display_card_visual(c,"aifull-visual-cards","")
        user_cards.pop(idx)
        def_idx=None
        for i,aicard in enumerate(AI_cards):
            if can_defend(aicard,c,trump_suit):
                def_idx=i
                break
        if def_idx is not None:
            # (3) "–°–µ–ª–µ—Å—Ç–∏—è –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è..."
            def_card=AI_cards[def_idx]
            patched_set_action_message("aifull","–°–µ–ª–µ—Å—Ç–∏—è –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è...")
            display_card_visual(def_card,"aifull-visual-cards","")
            # (4) "–°–µ–ª–µ—Å—Ç–∏—è –æ—Ç–±–∏–ª—Å—è!"
            patched_set_action_message("aifull","–°–µ–ª–µ—Å—Ç–∏—è –æ—Ç–±–∏–ª—Å—è!")
            discard_cards_bito("aifull",[c,def_card])
            AI_cards.pop(def_idx)
            current_attacker="AI"
            allow_user_click=False
            # (2) "–°–µ–ª–µ—Å—Ç–∏—è –∞—Ç–∞–∫—É–µ—Ç..."
            patched_set_action_message("aifull","–°–µ–ª–µ—Å—Ç–∏—è –∞—Ç–∞–∫—É–µ—Ç –ò–≥—Ä–æ–∫–∞!")
            timer.set_timeout(ai_attack,2000)
        else:
            # (5) "–°–µ–ª–µ—Å—Ç–∏—è –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë–º –∫–∞—Ä—Ç—ã"
            patched_set_action_message("aifull","–°–µ–ª–µ—Å—Ç–∏—è –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã")
            document["aifull-visual-cards"].clear()
            AI_cards.append(c)
            # —Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç...
            patched_set_action_message("aifull","–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –ò–≥—Ä–æ–∫—É. –ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç –°–µ–ª–µ—Å—Ç–∏—é!")
        AI_cards=draw_until_6(AI_cards,deck)
        user_cards=draw_until_6(user_cards,deck)
        update_aifull_ui()

def restart_aifull():
    jokers_checked=document["cb_jokers"].checked
    sixplus_checked=document["cb_6plus"].checked
    start_aifull_game(sixplus_checked,jokers_checked)

#########################################
# –ú–£–õ–¨–¢–ò
#########################################
n_players=3
hands=[]
deck_multi=[]
trump_multi=""
cur_attacker=0
log_multi=[]
allow_click_multi=False

def determine_first_attacker_multi():
    best=None
    best_idx=None
    for i,hand in enumerate(hands):
        if eliminated[i]:
            continue
        trump_cards=[c for c in hand if c[1]==trump_multi]
        if trump_cards:
            rmins=[rank_index(x[0]) for x in trump_cards]
            m=min(rmins)
        else:
            m=999
        if best is None or m<best:
            best=m
            best_idx=i
    if best_idx is None or best==999:
        return 0
    return best_idx

def game_over_multi(winner,winner_idx):
    global allow_click_multi,hands,ranks_done
    place=ranks_done+1
    ranks_done+=1
    eliminated[winner_idx]=True
    if winner=="player":
        if place==1:
            patched_set_action_message("aifull-multi",f"–ü–û–ë–ï–î–ò–¢–ï–õ–¨: {player_name.upper()} (1 –º–µ—Å—Ç–æ)!")
            for i in range(len(hands)):
                hands[i]=[]
            allow_click_multi=False
        else:
            patched_set_action_message("aifull-multi",f"{player_name} –∑–∞–Ω—è–ª {place} –º–µ—Å—Ç–æ!")
            for i in range(len(hands)):
                hands[i]=[]
            allow_click_multi=False
    else:
        nm=get_ai_name(winner_idx)
        patched_set_action_message("aifull-multi",f"{nm} –∑–∞–Ω—è–ª {place} –º–µ—Å—Ç–æ!")
        hands[winner_idx]=[]
        if place==total_players_count-0:
            allow_click_multi=False
        else:
            pass
    document["aifull-multi-visual-cards"].clear()

def check_win_conditions_multi():
    global n_players,ranks_done
    arr=[i for i,h in enumerate(hands) if len(h)>0 and not eliminated[i]]
    if len(arr)==1:
        last_idx=arr[0]
        place=ranks_done+1
        ranks_done+=1
        if last_idx==0:
            patched_set_action_message("aifull-multi",f"{player_name} –æ—Å—Ç–∞–ª—Å—è –ø–æ—Å–ª–µ–¥–Ω–∏–º, –æ–Ω –ø—Ä–æ–∏–≥—Ä–∞–ª!")
            for i in range(n_players):
                hands[i]=[]
            allow_click_multi=False
        else:
            nm=get_ai_name(last_idx)
            patched_set_action_message("aifull-multi",f"{nm} –ø—Ä–æ–∏–≥—Ä–∞–ª –ø–æ—Å–ª–µ–¥–Ω–∏–º!")
            for i in range(n_players):
                hands[i]=[]
            allow_click_multi=False

def start_aifull_multi(only_6plus,with_jokers,total):
    start_aifull_multi_game(only_6plus,with_jokers,total)

def start_aifull_multi_game(only_6plus,with_jokers,total_players):
    global n_players,hands,deck_multi,trump_multi,cur_attacker,log_multi,allow_click_multi
    global eliminated,ranks_done,total_players_count
    n_players=total_players
    total_players_count=n_players
    eliminated=[False]*n_players
    ranks_done=0
    deck_multi=create_deck(only_6plus,with_jokers)
    random.shuffle(deck_multi)
    hands=[]
    off=0
    for i in range(n_players):
        h=deck_multi[off:off+6]
        off+=6
        hands.append(h)
    deck_multi=deck_multi[off:]
    suits=["‚ô†","‚ô•","‚ô¶","‚ô£","‚≠ê","üåô","‚öú"]
    trump_multi=random.choice(suits)
    cur_attacker=determine_first_attacker_multi()
    log_multi=[f"–ù–∞—á–∏–Ω–∞–µ–º (1—á–µ–ª + {n_players-1} –ò–ò)."]
    document["trump-card-multi"].innerHTML=f"<div style='font-size:1.5rem;'>{trump_multi}</div>"
    document["trump-card-multi"].style.display="flex"
    clear_visual_cards("aifull-multi-visual-cards")
    document["discard-pile-multi"].clear()
    document["discard-pile-multi"].style.display="none"
    allow_click_multi=(cur_attacker==0)

    # (1) "X —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º!"
    if cur_attacker==0:
        patched_set_action_message("aifull-multi", f"{player_name} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º!")
    else:
        patched_set_action_message("aifull-multi", f"{get_ai_name(cur_attacker)} —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º!")
        timer.set_timeout(lambda: ai_multi_attack(cur_attacker),2000)
    update_aifull_multi_ui()
    switch_view("aifull-multi-screen")

def update_aifull_multi_ui():
    global log_multi,cur_attacker,hands
    document["aifull-multi-log"].innerHTML="<pre>"+"\n".join(log_multi)+"</pre>"
    turn_text=(f"{get_ai_name(cur_attacker)}" if cur_attacker!=0 else player_name)
    document["multi-turn"].textContent=turn_text
    ul=document["user-multi-cards"]
    ul.clear()
    for i,c in enumerate(hands[0]):
        li=document.createElement("li")
        li.classList.add("card-item")
        li.innerHTML=str(c)
        def on_click(ev, idx=i):
            handle_multi_card_click(idx)
        li.bind("click", on_click)
        ul.appendChild(li)
    check_win_conditions_multi()

def handle_multi_card_click(idx):
    global allow_click_multi,hands,cur_attacker,deck_multi,log_multi,trump_multi,n_players,eliminated
    if not allow_click_multi:return
    if idx<0 or idx>=len(hands[0]):return
    patched_clear_action("aifull-multi")
    defender=(cur_attacker+1)%n_players
    while eliminated[defender] and defender!=cur_attacker:
        defender=(defender+1)%n_players
    selected_card=hands[0][idx]
    # (2) "–ò–≥—Ä–æ–∫ –∞—Ç–∞–∫—É–µ—Ç –ò–ò"
    patched_set_action_message("aifull-multi",f"{player_name} –∞—Ç–∞–∫—É–µ—Ç {get_ai_name(defender)}!")
    display_card_visual(selected_card,"aifull-multi-visual-cards","")
    hands[0].pop(idx)
    def_card=None
    def_idx=None
    for i,c in enumerate(hands[defender]):
        if can_defend(c,selected_card,trump_multi):
            def_card=c
            def_idx=i
            break
    if def_card:
        # (3) "–ò–ò –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è..."
        display_card_visual(def_card,"aifull-multi-visual-cards","")
        log_multi.append(f"{get_ai_name(defender)} –æ—Ç–±–∏–ª—Å—è!")
        cur_attacker=defender
        hands[defender].pop(def_idx)
        allow_click_multi=False
        # (4) "–ò–ò –æ—Ç–±–∏–ª—Å—è!", —É–±–∏—Ä–∞–µ–º –≤—Å–µ –∫–∞—Ä—Ç—ã -> –±–∏—Ç–æ
        patched_set_action_message("aifull-multi",f"{get_ai_name(defender)} –æ—Ç–±–∏–ª—Å—è!")
        discard_cards_bito("aifull-multi",[selected_card,def_card])
        do_multi_draw()
        # –¥–∞–ª–µ–µ "X –∞—Ç–∞–∫—É–µ—Ç..."
        patched_set_action_message("aifull-multi", f"{get_ai_name(cur_attacker)} –∞—Ç–∞–∫—É–µ—Ç!")
        timer.set_timeout(lambda: ai_multi_attack(cur_attacker),2000)
    else:
        # (5) "–ò–ò –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä–µ–º –∫–∞—Ä—Ç—ã"
        log_multi.append(f"{get_ai_name(defender)} –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—É.")
        patched_set_action_message("aifull-multi", f"{get_ai_name(defender)} –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã")
        document["aifull-multi-visual-cards"].clear()
        hands[defender].append(selected_card)
        do_multi_draw()
        # "—Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫..."
        nxt=(defender+1)%n_players
        while eliminated[nxt] and nxt!=defender:
            nxt=(nxt+1)%n_players
        cur_attacker=nxt
        if cur_attacker==0:
            allow_click_multi=True
            log_multi.append(f"{player_name} —Ö–æ–¥–∏—Ç (–ø–æ—Å–ª–µ –Ω–µ—É–¥–∞—á–Ω–æ–π –∑–∞—â–∏—Ç—ã {get_ai_name(defender)}).")
            patched_set_action_message("aifull-multi", f"–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ {player_name}. {player_name} –∞—Ç–∞–∫—É–µ—Ç!")
        else:
            patched_set_action_message("aifull-multi", f"–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ {get_ai_name(cur_attacker)}. {get_ai_name(cur_attacker)} –∞—Ç–∞–∫—É–µ—Ç!")
            timer.set_timeout(lambda: ai_multi_attack(cur_attacker),2000)
    update_aifull_multi_ui()

def ai_multi_attack(att_idx):
    global hands,deck_multi,log_multi,allow_click_multi,cur_attacker,n_players,trump_multi,eliminated
    if eliminated[att_idx]:return
    if len(hands[att_idx])==0:return
    df=(att_idx+1)%n_players
    while eliminated[df] and df!=att_idx:
        df=(df+1)%n_players
    # (2) "–ò–ò[X] –∞—Ç–∞–∫—É–µ—Ç –ò–ò[Y]"
    patched_set_action_message("aifull-multi", f"{get_ai_name(att_idx)} –∞—Ç–∞–∫—É–µ—Ç {get_ai_name(df)}!")
    atk_card=hands[att_idx][0]
    display_card_visual(atk_card,"aifull-multi-visual-cards","")
    if df==0:
        allow_click_multi=True
    else:
        def_i=None
        for i,c in enumerate(hands[df]):
            if can_defend(c,atk_card,trump_multi):
                def_i=i
                break
        if def_i is not None:
            # (3) "–ò–ò[df] –æ—Ç–±–∏–≤–∞–µ—Ç—Å—è..."
            def_card=hands[df][def_i]
            display_card_visual(def_card,"aifull-multi-visual-cards","")
            log_multi.append(f"{get_ai_name(df)} –æ—Ç–±–∏–ª—Å—è!")
            cur_attacker=df
            hands[df].pop(def_i)
            hands[att_idx].pop(0)
            # (4) "–ò–ò[df] –æ—Ç–±–∏–ª—Å—è!"
            patched_set_action_message("aifull-multi", f"{get_ai_name(df)} –æ—Ç–±–∏–ª—Å—è!")
            discard_cards_bito("aifull-multi",[atk_card,def_card])
        else:
            # (5) "–ò–ò[df] –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã"
            log_multi.append(f"{get_ai_name(df)} –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—É.")
            patched_set_action_message("aifull-multi",f"{get_ai_name(df)} –Ω–µ –æ—Ç–±–∏–ª—Å—è, –±–µ—Ä—ë—Ç –∫–∞—Ä—Ç—ã")
            document["aifull-multi-visual-cards"].clear()
            hands[df].append(atk_card)
            hands[att_idx].pop(0)
            nxt=(df+1)%n_players
            while eliminated[nxt] and nxt!=df:
                nxt=(nxt+1)%n_players
            cur_attacker=nxt
        do_multi_draw()
        if cur_attacker!=df:
            if len(hands[cur_attacker])>0 and not eliminated[cur_attacker]:
                # "—Ö–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç..."
                patched_set_action_message("aifull-multi", f"–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ {get_ai_name(cur_attacker)}. {get_ai_name(cur_attacker)} –∞—Ç–∞–∫—É–µ—Ç!")
                timer.set_timeout(lambda: ai_multi_attack(cur_attacker),2000)
        else:
            if cur_attacker==0:
                allow_click_multi=True
                log_multi.append("–¢–µ–ø–µ—Ä—å –≤–∞—à —Ö–æ–¥.")
                patched_set_action_message("aifull-multi", f"–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ {player_name}. –í–∞—à —Ö–æ–¥!")
            else:
                patched_set_action_message("aifull-multi",f"–•–æ–¥ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ {get_ai_name(cur_attacker)}. {get_ai_name(cur_attacker)} –∞—Ç–∞–∫—É–µ—Ç {get_ai_name((cur_attacker+1)%n_players)}!")
                timer.set_timeout(lambda: ai_multi_attack(cur_attacker),2000)
    update_aifull_multi_ui()

def do_multi_draw():
    global hands,deck_multi,cur_attacker,n_players,eliminated
    order=[cur_attacker]
    for i in range(n_players):
        if i!=cur_attacker and not eliminated[i]:
            order.append(i)
    for idx in order:
        hands[idx]=draw_until_6(hands[idx],deck_multi)

def restart_aifull_multi():
    jokers_checked=document["cb_jokers"].checked
    sixplus_checked=document["cb_6plus"].checked
    ai_str=document["ai_players_count"].value
    try:
        ai_num=int(ai_str)
    except:
        ai_num=3
    if ai_num<3:ai_num=3
    if ai_num>4:ai_num=4
    start_aifull_multi_game(sixplus_checked,jokers_checked,ai_num)

def start_new_game():
    mode_value=document["select_mode"].value
    jokers_checked=document["cb_jokers"].checked
    sixplus_checked=document["cb_6plus"].checked

    radio_list=document.select("[name='game_type']")
    game_type="ai"
    for r in radio_list:
        if r.checked:
            game_type=r.value
            break

    if game_type=="ai":
        ai_count_str=document["ai_players_count"].value
        try:
            ai_count=int(ai_count_str)
        except:
            ai_count=2
        if ai_count<2:ai_count=2
        if ai_count>4:ai_count=4
        if ai_count==2:
            start_aifull_game(sixplus_checked,jokers_checked)
        else:
            start_aifull_multi(sixplus_checked,jokers_checked,ai_count)
    else:
        multi_count_str=document["multi_players_count"].value
        try:
            multi_count=int(multi_count_str)
        except:
            multi_count=4
        if multi_count<2:multi_count=2
        if multi_count>10:multi_count=10
        rlist=document.select("[name='room_type']")
        rt="link"
        for rr in rlist:
            if rr.checked:
                rt=rr.value
                break
        document["chosen_mode"].textContent=mode_value
        document["chosen_jokers"].textContent="–î–∞" if jokers_checked else "–ù–µ—Ç"
        document["chosen_6plus"].textContent="–î–∞" if sixplus_checked else "–ù–µ—Ç"
        document["chosen_players"].textContent=str(multi_count)
        document["chosen_type"].textContent="–ú—É–ª—å—Ç–∏–ø–ª–µ–µ—Ä"
        if rt=="link":
            rtxt="–ü–æ —Å—Å—ã–ª–∫–µ"
        else:
            rtxt="–û—Ç–∫—Ä—ã—Ç–∞—è"
        document["chosen_room"].textContent=rtxt

        switch_view("game-screen")

########################################################
# –û—á–µ—Ä–µ–¥—å –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–∞—Ä—Ç/—Å–æ–æ–±—â–µ–Ω–∏–π
########################################################
_card_queue=[]
_busy=False

def delayed_show_next():
    global _card_queue,_busy
    if not _card_queue:
        _busy=False
        return
    _busy=True
    item=_card_queue.pop(0)
    kind=item[0]
    if kind=='card':
        card, parent_id=item[1],item[2]
        cont=document[parent_id]
        new_div=document.createElement("div")
        new_div.classList.add("card-item")
        new_div.style.display="inline-block"
        rank,suit,jk=card
        card_text="Joker" if jk else f"{rank}{suit}"
        new_div.innerHTML=card_text
        cont.appendChild(new_div)
    elif kind=='message':
        scr, txt=item[1], item[2]
        _old_set_action_message(scr,txt)
    timer.set_timeout(delayed_show_next,2000)

def _old_set_action_message(screen_id, txt):
    if screen_id=="aifull":
        txt=txt.replace("–ò–ò","–°–µ–ª–µ—Å—Ç–∏—è")
    txt=txt.replace("AI[1]","–°–µ–ª–µ—Å—Ç–∏—è").replace("AI[2]","–õ—é–º–∏–Ω").replace("AI[3]","–ò—Ç–µ—Ä")
    txt=txt.replace("AI[0]", player_name).replace("–ò–ò[0]", player_name)
    txt=txt.replace("–ò–≥—Ä–æ–∫",player_name)
    document[screen_id+"-action"].innerHTML=txt

def patched_set_action_message(screen_id, txt):
    _old_set_action_message(screen_id, txt) 
    _card_queue.append(('message',screen_id,txt))
    global _busy
    if not _busy:
        _busy=True
        timer.set_timeout(delayed_show_next,2000)

def patched_clear_action(screen_id):
    document[screen_id+"-action"].innerHTML=""

set_action_message=patched_set_action_message

def discard_cards_bito(screen_id, cards):
    if screen_id=="aifull":
        pile_id="discard-pile"
        field_id="aifull-visual-cards"
    else:
        pile_id="discard-pile-multi"
        field_id="aifull-multi-visual-cards"
    if pile_id in document:
        document[field_id].clear()
        pile=document[pile_id]
        pile.clear()
        pile.style.display="flex"
        new_div=document.createElement("div")
        new_div.classList.add("card-back")
        pile.appendChild(new_div)

def get_ai_name(ai_idx):
    if ai_idx==1:return "–°–µ–ª–µ—Å—Ç–∏—è"
    elif ai_idx==2:return "–õ—é–º–∏–Ω"
    elif ai_idx==3:return "–ò—Ç–µ—Ä"
    return f"AI[{ai_idx}]"

from browser import window
window.open_screen=open_screen
window.back_to_menu=back_to_menu
window.start_new_game=start_new_game
window.restart_aifull=restart_aifull
window.restart_aifull_multi=restart_aifull_multi
window.save_player_name=save_player_name

def _hide_text_logs():
    if "aifull-log" in document:
        document["aifull-log"].style.display="none"
    if "aifull-multi-log" in document:
        document["aifull-multi-log"].style.display="none"

_hide_text_logs()
</script>
</body>
</html>
